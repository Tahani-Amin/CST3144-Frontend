<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Full Stack Web App - Coursework 3144</title>

  <!-- CDN link for Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>

  <link href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <link rel="stylesheet" href="style.css">
  <!-- <script src="lessons.js"></script> -->

</head>

<body>
  <div class="page-bg"></div>

  <main id="app" class="page"> <!-- My main Vue app container for mounting-->
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <h2>Search</h2>
      <div class="group">
        <label class="label">Find a course</label>
        <!-- binds the input value to the data property -->
        <input class="input" type="text" placeholder="Search by subject, location…" v-model="searchTerm" />
      </div>

      <hr />

      <!-- Sort section -->
      <h2>Sort</h2>
      <div class="group">
        <label class="label">Sort by</label>
        <select class="select" v-model="sortBy">
          <option value="subject">Subject</option>
          <option value="location">Location</option>
          <option value="price">Price</option>
          <option value="spaces">Spaces</option>
        </select>
      </div>

      <!-- Order lessons by section -->
      <div class="group">
        <label class="label">Order</label>
        <select class="select" v-model="sortOrder">
          <option value="ascending">Ascending</option>
          <option value="descending">Descending</option>
        </select>
      </div>

      <hr />

      <!-- Filter section -->
      <h2>Filter</h2>
      <div class="group">
        <span class="label">Location</span>
        <div class="checks">
          <label class="check"><input type="checkbox"> London</label>
          <label class="check"><input type="checkbox"> Oxford</label>
          <label class="check"><input type="checkbox"> York</label>
          <label class="check"><input type="checkbox"> Bristol</label>
        </div>
      </div>

      <!-- Filter by subject section -->
      <div class="group">
        <span class="label">Subject</span>
        <div class="checks">
          <label class="check"><input type="checkbox"> Math</label>
          <label class="check"><input type="checkbox"> English</label>
          <label class="check"><input type="checkbox"> Music</label>
          <label class="check"><input type="checkbox"> Science</label>
        </div>
      </div>
    </aside>

    <!-- Courses  -->
    <section class="content">
      <div class="content-header">
        <h1 class="content-title">{{ showCart ? 'Your Cart' : 'Courses' }}</h1> <!-- Ternary operations to switch the title based on the view -->
      </div>

      <!-- Shows lessons if not in cart view -->
      <div v-if="!showCart" class="courses-grid">
        <!-- iterates through each lesson in sortedLessons -->
        <article class="course-card" v-for="lesson in sortedLessons" v-bind:key="lesson.id"> 
          
          <div class="course-header">
            <h3 class="course-title">{{ lesson.subject }} — {{ lesson.location }}</h3>
            <i v-bind:class="['course-icon', lesson.icon]"></i>  <!-- binds the icon class to the lesson icon -->
          </div>

          <p class="course-description">{{ lesson.desc }}</p>

          <p class="course-details">
            Price: £{{ lesson.price }} ·
            Spaces: {{ lesson.spaces - cartCount(lesson.id) }} <!-- shows the remaining spaces after counting the spaces in cart -->
          </p>

          <button
            class="btn btn-cart"
            v-bind:class="{'btn-disabled': !canAddToCart(lesson)}" 
            v-bind:disabled="!canAddToCart(lesson)"
            v-on:click="addToCart(lesson)" >
            <i class="fa-solid fa-cart-plus"></i> 
            Add to Cart
          </button>
        </article>
      </div>

      <!-- Cart page -->
      <div v-else>
        <div v-if="cartItemCount" class="cart-list">
          <div class="cart-item" v-for="(item, cartItems) in cartLessonObjects" v-bind:key="cartItems">
            <div>
              <h4>
                <i v-bind:class="['fa-fw', item.icon]" style="margin-right:8px;"></i>
                {{ item.subject }} — {{ item.location }}
              </h4>
              <p>Price: £{{ item.price }}</p>
            </div>
            <button class="btn-remove" v-on:click="removeFromCart(item)">
              <i class="fa-solid fa-minus-circle"></i>
              Remove
            </button>
          </div>
        </div>
        <p v-else>Your cart is empty.</p>

        <div class="checkout">
          <h3 style="margin:0;">Checkout</h3>

          <div class="row">
            <label for="customerName">Name</label>
            <input
              id="customerName"
              class="field"
              type="text"
              v-model.trim="customerName"
              placeholder="Please enter your full name"
            />
            <div class="validation" v-if="!customerName">
              Enter your full name using letters and spaces.
            </div>
            <div class="validation-error" v-else-if="!nameValid">
              Name must contain letters and spaces only.
            </div>
            <div class="validation-success" v-else>Looks good.</div>
          </div>

          <div class="row">
            <label for="customerPhone">Phone</label>
            <input
              id="customerPhone"
              class="field"
              type="text"
              v-model.trim="customerPhone"
              placeholder="Phone (numbers only)"
            />
            <div class="validation" v-if="!customerPhone">
              Enter digits only, e.g., 07123456789.
            </div>
            <div class="validation-error" v-else-if="!phoneValid">
              Phone must contain numbers only.
            </div>
            <div class="validation-success" v-else>Looks good.</div>
          </div>

          <div class="row">
            <label for="customerEmail">Email</label>
            <input
              id="customerEmail"
              class="field"
              type="text"
              v-model.trim="customerEmail"
              placeholder="Email (must contain @)"
            />
            <div class="validation" v-if="!customerEmail">
              Enter your email (must include @).
            </div>
            <div class="validation-error" v-else-if="!emailValid">
              Email must contain the @ symbol.
            </div>
            <div class="validation-success" v-else>Looks good.</div>
          </div>

          <button
            class="btn-checkout"
            v-bind:disabled="!canCheckout"
            v-on:click="submitOrder"
          >
            <i class="fa-solid fa-check"></i> Checkout
          </button>

          <div class="confirm" v-if="orderSubmitted">
            Order submitted! We’ll contact you soon.
          </div>
        </div>
      </div>
    </section>

    <!-- Cart Button -->
    <div class="cart-button">
      <button
        v-bind:disabled="cartItemCount === '' && !showCart"
        v-on:click="toggleCart"
      >
        <i
          class="fa-solid"
          v-bind:class="showCart ? 'fa-arrow-left' : 'fa-cart-shopping'"
        ></i>
        <span>{{ showCart ? 'Back' : 'Cart' }}</span>
        <span class="cart-count" v-if="cartItemCount">{{ cartItemCount }}</span>
      </button>
    </div>
  </main>
  

</body>
</html>


<script type="text/javascript">
  let Webstore = new Vue({ // New Vue Instance
    el: '#app', // Mounts on the "id = app"
    data: {
      lessons: [], // the array of lesson object fetched from backend       
      cart: [], // the array of lesson Ids added to cart
           
      // default data values   
      showCart: false,         
      sortBy: 'subject',
      sortOrder: 'ascending',
      searchTerm: '',

      // Checkout fields
      customerName: '',
      customerPhone: '',
      customerEmail: '',
      orderSubmitted: false
    },

    created() { // Runs right after the vue instance is created
      this.fetchLessons("");
    },
        
    watch: { // Runs everytime the data value is changed
      searchTerm(newValue) {
        this.fetchLessons(newValue);
        console.log("The user searched for:", `"${newValue}"`);

      }
    },

    computed: {

      cartItemCount() {
        return this.cart.length || "";
      },

      // sorts the lessons based on selected critria
      sortedLessons() {
        let list = this.lessons.slice(0); 
        const orderBy = this.sortOrder === 'descending' ? -1 : 1;

        const remaining = (lesson) => lesson.spaces - this.cartCount(lesson.id);

        const compare = (a, b) => {
          let A, B;
          if (this.sortBy === 'price') {
            A = a.price; B = b.price;
          } else if (this.sortBy === 'spaces') {
            A = remaining(a); B = remaining(b);
          } else if (this.sortBy === 'location') {
            A = a.location.toLowerCase(); B = b.location.toLowerCase();
          } else {
            A = a.subject.toLowerCase(); B = b.subject.toLowerCase();
          }
          if (A > B) return 1 * orderBy;
          if (A < B) return -1 * orderBy;
          return 0;
        };

        return list.sort(compare);
      },

      // 
      cartLessonObjects() {
        return this.cart.map(id => this.lessons.find(l => l.id === id));
      },

      // Checks if the name is valid
      nameValid() {
        const re = /^[A-Za-z\s]+$/;
        return this.customerName.length > 0 && re.test(this.customerName);
      },
      // Checks if the phone is valid
      phoneValid() {
        const re = /^[0-9]+$/;
        return this.customerPhone.length > 0 && re.test(this.customerPhone);
      },
      emailValid() {
        return this.customerEmail.includes("@") && this.customerEmail.length > 3;
      },

      // returns both name and phone are valid
      canCheckout() {
        return this.nameValid && this.phoneValid && this.emailValid && this.cart.length > 0;  
      }
    },

    methods: {

      // validation to check if lesson can be added to cart
      canAddToCart(lesson) {
        return lesson.spaces > this.cartCount(lesson.id);
      },
      // Adds lesson to cart
      addToCart(lesson) {
        if (!this.canAddToCart(lesson)) {
          console.log("Spaces full:", lesson.subject);
          return;
        }
        console.log("Added to cart", lesson.subject, lesson.location);
        this.cart.push(lesson.id);
      },
      // Removes lessson from th cart
      removeFromCart(lesson) {
        console.log("Removed from cart:", lesson.subject);
        const cartItems = this.cart.indexOf(lesson.id);
        if (cartItems !== -1) this.cart.splice(cartItems, 1);
      },

      // Counts how many of a lesson are in the cart
      cartCount(id) {
        let count = 0;
        for (let i = 0; i < this.cart.length; i++) {
          if (this.cart[i] === id) count++;
        }
        return count;
      },
      // Toggles between my lessons page and cart page
      toggleCart() {
        if (!this.cart.length && !this.showCart) return;  
        this.showCart = !this.showCart;
      },

      // Submits the order to the backend
      submitOrder() {
        if (!this.canCheckout) return;
        console.log("Checkout submitted!");

        // Build an array of unique lesson IDs from the cart manually
        const uniqueLessonIds = [];
        for (let i = 0; i < this.cart.length; i++) {
          const id = this.cart[i];
          if (!uniqueLessonIds.includes(id)) {
            uniqueLessonIds.push(id);
          }
        }

        // Build the detailed lessons array
        const lessonsDetail = uniqueLessonIds
          .map(id => {
            const lessonObj = this.lessons.find(l => l.id === id);
            if (!lessonObj) return null;

            return {
              id: id,
              subject: lessonObj.subject,
              spacesBooked: this.cartCount(id)
            };
          })
          .filter(item => item !== null);

        const orderData = {
          name: this.customerName,
          phone: this.customerPhone,
          email: this.customerEmail,

          lessonIds: uniqueLessonIds,
          lessons: lessonsDetail,

          totalSpaces: this.cart.length,
          orderDate: new Date().toISOString()
        };

        // Posting the order
        fetch("https://cst3144-backend-8tqe.onrender.com/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(orderData)
        })
          .then(res => res.json())
          .then(savedOrder => {
            console.log("Order saved:", savedOrder);

            lessonsDetail.forEach(item => {
              const lesson = this.lessons.find(l => l.id === item.id);
              if (!lesson) return;

              const newSpaces = lesson.spaces - item.spacesBooked;

              fetch("https://cst3144-backend-8tqe.onrender.com/lessons/" + item.id, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ spaces: newSpaces })
              })
                .then(r => r.json())
                .then(result => {
                  console.log("Updated lesson", item.id, "spaces ->", newSpaces, result);
                })
                .catch(err => {
                  console.error("Error updating lesson spaces for", item.id, err);
                });
            });

            this.orderSubmitted = true;
            alert("Order submitted!");

            this.cart = [];
            this.customerName = "";
            this.customerPhone = "";
            this.customerEmail = "";

            this.showCart = false;

            this.fetchLessons(this.searchTerm);
          })
          .catch(err => {
            console.error("Order error:", err);
            alert("There was an error submitting the order.");
          });
      },

      fetchLessons(query) {
        console.log("fetchLessons() query =", `"${query}"`);

        let url = "https://cst3144-backend-8tqe.onrender.com/lessons";

        if (query && query.trim() !== "") {
          url = "https://cst3144-backend-8tqe.onrender.com/search?q=" + encodeURIComponent(query.trim());
        }

        fetch(url)
          .then(response => response.json())
          .then(data => {
            this.lessons = data;
          })
          .catch(err => {
            console.error("Error fetching lessons:", err);
          });
      }

    }
  });
</script>
</body>
</html>
