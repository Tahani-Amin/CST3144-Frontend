<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Full Stack Web App - Coursework 3144</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>

  <link href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="lessons.js"></script>
    
<style>
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; }
  body {
    background: #0b1020;
    color: #0f172a;
    font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    line-height: 1.45;
  }

  .page-bg{
    position: fixed; inset: 0;
    background: url("Images/bkg.png") center/cover no-repeat;
    z-index: -2;
  }

  .page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px 20px;
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
    min-height: 100vh;
  }

  .sidebar {
    background: rgba(0,0,0,.28);
    border: 1px solid rgba(15, 23, 42, .18);
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 8px 20px rgba(2, 6, 23, .12);
    color: #fff;
  }
  .sidebar h2 { margin: 0 0 12px; font-weight: 600; }
  .label { display: block; font-size: .9rem; margin-bottom: 6px; }
  .input, .select {
    width: 100%;
    border-radius: 10px;
    border: 1px solid rgba(15, 23, 42, .18);
    background: rgba(255,255,255,.10);
    color: #fff;
    padding: 10px 12px;
    outline: none;
  }
  .input::placeholder { color: rgba(255,255,255,.75); }
  .sidebar hr { border: 0; border-top: 1px solid rgba(15, 23, 42, .18); margin: 14px 0; }

  .content { display: grid; grid-template-rows: auto 1fr; gap: 14px; }
  .content-title { margin: 0; font-size: 1.25rem; font-weight: 600; }

  .courses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 18px;
    justify-content: start;
  }

  .course-card {
    background: rgba(255,255,255,.60);
    border: 1px solid rgba(15, 23, 42, .18);
    border-radius: 14px;
    padding: 14px 16px;
    box-shadow: 0 8px 20px rgba(2, 6, 23, .12);
    transition: background .15s ease, transform .06s ease, border-color .15s ease;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 200px;
    overflow: hidden;
  }
  .course-card:hover {
    background: rgba(255,255,255,.72);
    transform: translateY(-1px);
    border-color: rgba(255,255,255,.6);
  }

  .course-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .course-title { margin: 0; font-weight: 600; font-size: 1rem; color: #0f172a; }
  .course-icon { font-size: 2rem; color: #6d28d9; flex-shrink: 0; }

  .course-description {
    margin: 6px 0;
    font-size: 0.85rem;
    color: #334155;
    line-height: 1.3;
    height: 2.6em;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .course-details { margin: 0; font-size: 0.85rem; color: #334155; }

  .btn-cart {
    background: linear-gradient(180deg, #8b5cf6 0%, #6d28d9 100%);
    color: #ffffff;
    border-radius: 9999px;
    width: 120px;
    height: 34px;
    font-size: .85rem;
    border: none;
    font-weight: 600;
    align-self: center;
    box-shadow: 0 3px 12px rgba(109,40,217,.28);
    cursor: pointer;
  }
  .btn-cart:hover { transform: translateY(-1px); filter: brightness(1.06); }
  .btn-disabled { opacity: .55; cursor: not-allowed; }

  /* The cart page */
  .cart-list { display: grid; gap: 12px; }
  .cart-item {
    display: grid; grid-template-columns: 1fr auto; align-items: center;
    background: rgba(255,255,255,.60);
    border: 1px solid rgba(15, 23, 42, .18);
    border-radius: 12px;
    padding: 12px 14px;
    box-shadow: 0 8px 20px rgba(2, 6, 23, .12);
  }
  .cart-item h4 { margin: 0 0 4px; font-size: 1rem; }
  .cart-item p { margin: 0; color: #334155; font-size: .9rem; }
  .btn-remove {
    background: #fff;
    border: 1px solid rgba(15, 23, 42, .18);
    padding: 8px 12px;
    border-radius: 9999px;
    cursor: pointer;
    font-weight: 600;
  }
  .btn-remove:hover { transform: translateY(-1px); }

  /* checkout part */
  .checkout {
    margin-top: 18px;
    background: rgba(255,255,255,.60);
    border: 1px solid rgba(15, 23, 42, .18);
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(2, 6, 23, .12);
    padding: 16px;
    display: grid;
    gap: 12px;
  }
  .checkout .row { display: grid; gap: 6px; }
  .checkout label { font-weight: 600; font-size: .9rem; }
  .checkout .field {
    width: 100%; padding: 10px 12px; border-radius: 10px;
    border: 1px solid rgba(15, 23, 42, .18); outline: none;
  }
  .validation { font-size: .85rem; color: #334155; }
  .validation-error { color: #dc2626; font-size: .85rem; }
  .validation-success { color: #16a34a; font-size: .85rem; }

  .btn-checkout {
    justify-self: start;
    background: linear-gradient(180deg, #8b5cf6 0%, #6d28d9 100%);
    color: #ffffff;
    border: none; border-radius: 9999px;
    padding: 10px 16px; font-weight: 800; cursor: pointer;
    box-shadow: 0 8px 22px rgba(109,40,217,.28);
  }
  .btn-checkout:disabled { opacity: .55; cursor: not-allowed; }
  .confirm {
    padding: 10px 12px;
    background: rgba(22,163,74,.12);
    border: 1px solid rgba(22,163,74,.35);
    color: #16a34a;
    border-radius: 10px;
    font-weight: 600;
  }

  /* cart button */
  .cart-button{
    position: fixed; right: 28px; bottom: 28px; z-index: 10;
  }
  .cart-button button{
    background: linear-gradient(180deg, #8b5cf6 0%, #6d28d9 100%);
    color: #fff;
    border: 1px solid rgba(255,255,255,.22);
    border-radius: 9999px;
    padding: 14px 22px;
    font-weight: 800; font-size: 1rem;
    display: inline-flex; align-items: center; gap: 10px;
    box-shadow: 0 10px 28px rgba(109,40,217,.45);
    cursor: pointer;
  }
  .cart-button button:hover{ transform: translateY(-1px); filter: brightness(1.07); }
  .cart-button .cart-count{
    margin-left: 8px;
    background: rgba(255,255,255,.2);
    border: 1px solid rgba(255,255,255,.4);
    border-radius: 999px;
    padding: 2px 8px;
    font-size: .85rem;
  }
  .cart-button button:disabled{ opacity: .55; cursor: not-allowed; }

  .sidebar h2::before, .content-title::before{
    content: ""; display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    background: #8b5cf6; margin-right: 8px; transform: translateY(-1px);
  }

  @media (max-width: 560px){
    .courses-grid{
      grid-template-columns: repeat(auto-fill, 190px);
      grid-auto-rows: 170px;
      justify-content: center;
    }
    .course-card{ height: 180px; }
  }
</style>

</head>

<body>
  <div class="page-bg"></div>

  <main id="app" class="page"> <!-- My main Vue app container -->
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <h2>Search</h2>
      <div class="group">
        <label class="label">Find a course</label>
        <input class="input" type="text" placeholder="Search by subject, location…" v-model="searchTerm" />
      </div>

      <hr />

    <!-- Sort section -->
      <h2>Sort</h2>
      <div class="group">
        <label class="label">Sort by</label>
        <select class="select" v-model="sortBy">
          <option value="subject">Subject</option>
          <option value="location">Location</option>
          <option value="price">Price</option>
          <option value="spaces">Spaces</option>
        </select>
      </div>

      <!-- Order lessons by section -->
      <div class="group">
        <label class="label">Order</label>
        <select class="select" v-model="sortOrder">
          <option value="ascending">Ascending</option>
          <option value="descending">Descending</option>
        </select>
      </div>

      <hr />

       <!-- Filter section -->

      <h2>Filter</h2>
      <div class="group">
        <span class="label">Location</span>
        <div class="checks">
          <label class="check"><input type="checkbox"> London</label>
          <label class="check"><input type="checkbox"> Oxford</label>
          <label class="check"><input type="checkbox"> York</label>
          <label class="check"><input type="checkbox"> Bristol</label>
        </div>
      </div>


      <!-- Filter by subject section -->
      <div class="group">
        <span class="label">Subject</span>
        <div class="checks">
          <label class="check"><input type="checkbox"> Math</label>
          <label class="check"><input type="checkbox"> English</label>
          <label class="check"><input type="checkbox"> Music</label>
          <label class="check"><input type="checkbox"> Science</label>
        </div>
      </div>
    </aside>

    <!-- Courses  -->
    <section class="content">
      <div class="content-header">
        <h1 class="content-title">{{ showCart ? 'Your Cart' : 'Courses' }}</h1> <!-- Ternary operations to switch the title based on the view -->
      </div>

      <!-- Lessons page -->
      <div v-if="!showCart" class="courses-grid">
        <article class="course-card" v-for="lesson in sortedLessons" :key="lesson.id">
          <div class="course-header">
            <h3 class="course-title">{{ lesson.subject }} — {{ lesson.location }}</h3>
            <i :class="['course-icon', lesson.icon]"></i>
          </div>

          <p class="course-description">{{ lesson.desc }}</p>

          <p class="course-details">
            Price: £{{ lesson.price }} ·
            Spaces: {{ lesson.spaces - cartCount(lesson.id) }}
          </p>

          <button
            class="btn btn-cart"
            :class="{'btn-disabled': !canAddToCart(lesson)}"
            :disabled="!canAddToCart(lesson)"
            @click="addToCart(lesson)" >
            <i class="fa-solid fa-cart-plus"></i>
            Add to Cart </button>
        </article>
      </div>

      <!-- Cart page -->
      <div v-else>
        <div v-if="cartItemCount" class="cart-list">
          <div class="cart-item" v-for="(item, cartItems) in cartLessonObjects" :key="cartItems">
            <div>
              <h4>
                <i :class="['fa-fw', item.icon]" style="margin-right:8px;"></i>
                {{ item.subject }} — {{ item.location }}
              </h4>
              <p>Price: £{{ item.price }}</p>
            </div>
            <button class="btn-remove" @click="removeFromCart(item)">
              <i class="fa-solid fa-minus-circle"></i>
              Remove
            </button>
          </div>
        </div>
        <p v-else>Your cart is empty.</p>

        <div class="checkout">
          <h3 style="margin:0;">Checkout</h3>

          <div class="row">
            <label for="customerName">Name</label>
            <input id="customerName" class="field" type="text" v-model.trim="customerName" placeholder="Please enter your full name" />
            <div class="validation" v-if="!customerName">Enter your full name using letters and spaces.</div>
            <div class="validation-error" v-else-if="!nameValid">Name must contain letters and spaces only.</div>
            <div class="validation-success" v-else>Looks good.</div>
          </div>

          <div class="row">
            <label for="customerPhone">Phone</label>
            <input id="customerPhone" class="field" type="text" v-model.trim="customerPhone" placeholder="Phone (numbers only)" />
            <div class="validation" v-if="!customerPhone">Enter digits only, e.g., 07123456789.</div>
            <div class="validation-error" v-else-if="!phoneValid">Phone must contain numbers only.</div>
            <div class="validation-success" v-else>Looks good.</div>
          </div>

          <div class="row">
            <label for="customerEmail">Email</label>
            <input id="customerEmail" class="field" type="text" v-model.trim="customerEmail" placeholder="Email (must contain @)" />
            <div class="validation" v-if="!customerEmail"> Enter your email (must include @). </div>
            <div class="validation-error" v-else-if="!emailValid">Email must contain the @ symbol. </div>
            <div class="validation-success" v-else>Looks good.</div>
          </div>

          <button class="btn-checkout" :disabled="!canCheckout" @click="submitOrder">
            <i class="fa-solid fa-check"></i> Checkout
          </button>

          <div class="confirm" v-if="orderSubmitted">
            Order submitted! We’ll contact you soon.
          </div>
        </div>
      </div>
    </section>

    <!-- Cart Button -->
    <div class="cart-button">
      <button :disabled="cartItemCount === '' && !showCart" @click="toggleCart" >
        <i class="fa-solid" :class="showCart ? 'fa-arrow-left' : 'fa-cart-shopping'"></i>
        <span>{{ showCart ? 'Back' : 'Cart' }}</span>
        <span class="cart-count" v-if="cartItemCount">{{ cartItemCount }}</span>
      </button>
    </div>
  </main>
  

</body>
</html>


<script type="text/javascript">
    let Webstore = new Vue({
      el: '#app',
      data: {
        lessons: [],       
        cart: [],                
        showCart: false,         
        sortBy: 'subject',
        sortOrder: 'ascending',
        searchTerm: '',

        // Checkout fields
        customerName: '',
        customerPhone: '',
        customerEmail: '',
        orderSubmitted: false
      },
      watch: {
        searchTerm(newValue) {
          this.fetchLessons(newValue);
        }
      },

      created() {
        this.fetchLessons("");
      },


      computed: {

        cartItemCount() {
          return this.cart.length || "";
        },

        sortedLessons() {
          let list = this.lessons.slice(0);
          const orderBy = this.sortOrder === 'descending' ? -1 : 1;

          const remaining = (lesson) => lesson.spaces - this.cartCount(lesson.id);

          const compare = (a, b) => {
            let A, B;
            if (this.sortBy === 'price') {
              A = a.price; B = b.price;
            } else if (this.sortBy === 'spaces') {
              A = remaining(a); B = remaining(b);
            } else if (this.sortBy === 'location') {
              A = a.location.toLowerCase(); B = b.location.toLowerCase();
            } else {
              A = a.subject.toLowerCase(); B = b.subject.toLowerCase();
            }
            if (A > B) return 1 * orderBy;
            if (A < B) return -1 * orderBy;
            return 0;
          };

          return list.sort(compare);
        },

        // 
        cartLessonObjects() {
          return this.cart.map(id => this.lessons.find(l => l.id === id));
        },

        // Checks if the name is valid
        nameValid() {
          const re = /^[A-Za-z\s]+$/;
          return this.customerName.length > 0 && re.test(this.customerName);
        },
        // Checks if the phone is valid
        phoneValid() {
          const re = /^[0-9]+$/;
          return this.customerPhone.length > 0 && re.test(this.customerPhone);
        },
        emailValid() {
          return this.customerEmail.includes("@") && this.customerEmail.length > 3;
        },


        // returns both name and phone are valid
        canCheckout() {
          return this.nameValid && this.phoneValid && this.emailValid && this.cart.length > 0;  
        }
      },

      methods: {

        // Checking if lesson can be added to cart
        canAddToCart(lesson) {
          return lesson.spaces > this.cartCount(lesson.id);
        },
        // Adds lesson to cart
        addToCart(lesson) {
          if (!this.canAddToCart(lesson)) return; 
          this.cart.push(lesson.id);
        },
        // Removes lessson from th cart
        removeFromCart(lesson) {
          const cartItems = this.cart.indexOf(lesson.id);
          if (cartItems !== -1) this.cart.splice(cartItems, 1);
        },
        // Counts how many of a lesson are in the cart
        cartCount(id) {
          let count = 0;
          for (let i = 0; i < this.cart.length; i++) {
            if (this.cart[i] === id) count++;
          }
          return count;
        },
        // Toggles between my lessons page and cart page
        toggleCart() {
          if (!this.cart.length && !this.showCart) return;  
          this.showCart = !this.showCart;
        },

        submitOrder() {
          if (!this.canCheckout) return;

          const uniqueLessonIds = [...new Set(this.cart)];

          const lessonsDetail = uniqueLessonIds.map(id => {
            const lessonObj = this.lessons.find(l => l.id === id);
            if (!lessonObj) return null;

            return {
              id: id,
              subject: lessonObj.subject,
              spacesBooked: this.cartCount(id)
            };
          }).filter(item => item !== null);

          const orderData = {
            name: this.customerName,
            phone: this.customerPhone,
            email: this.customerEmail,

            lessonIds: uniqueLessonIds,
            lessons: lessonsDetail,

            totalSpaces: this.cart.length,
            orderDate: new Date().toISOString()
          };

          // Posting the order
          fetch("http://localhost:3000/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderData)
          })
            .then(res => res.json())
            .then(savedOrder => {
              console.log("Order saved:", savedOrder);

              lessonsDetail.forEach(item => {
                const lesson = this.lessons.find(l => l.id === item.id);
                if (!lesson) return;

                const newSpaces = lesson.spaces - item.spacesBooked;

                fetch("http://localhost:3000/lessons/" + item.id, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ spaces: newSpaces })
                })
                  .then(r => r.json())
                  .then(result => {
                    console.log("Updated lesson", item.id, "spaces ->", newSpaces, result);
                  })
                  .catch(err => {
                    console.error("Error updating lesson spaces for", item.id, err);
                  });
              });

              this.orderSubmitted = true;
              alert("Order submitted!");

              this.cart = [];
              this.customerName = "";
              this.customerPhone = "";
              this.customerEmail = "";

              this.showCart = false;

              this.fetchLessons(this.searchTerm);
            })
            .catch(err => {
              console.error("Order error:", err);
              alert("There was an error submitting the order.");
            });
        },


        fetchLessons(query) {
          let url = "http://localhost:3000/lessons";

          if (query && query.trim() !== "") {
            url = "http://localhost:3000/search?q=" + encodeURIComponent(query.trim());
          }

          fetch(url)
            .then(response => response.json())
            .then(data => {
              this.lessons = data;
            })
            .catch(err => {
              console.error("Error fetching lessons:", err);
            });
        }



      }
    });
  </script>
</body>
</html>

